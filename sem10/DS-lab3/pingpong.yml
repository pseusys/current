templates:

  node:
    one_shot: False
    variables:
      id: 0
      started: False
    in_channels:
      - input
      - starter
    out_channels:
      - output
    rules:
      start:
        channel: starter
        if: 'message.text == "START" and not self.started'
        send:
          channel: output
          message:
            text: PING
            id: self.id
        set:
          started: True
      receive_ping:
        channel: input
        if: 'message.text == "PING" and self.id < message.id'
        send:
          channel: output
          message:
            text: PONG
            id: self.id
        set:
          started: True
      receive_pong:
        channel: input
        if: 'message.text == "PONG" and self.id > message.id'
        send:
          channel: output
          message:
            text: PING
            id: self.id

  firestarter:
    one_shot: True
    out_channels:
      - torch
    init:
      send:
        channel: torch
        message:
          text: START
          id: -1



matrix:

  pinger:
    template: node
    channels:
      input: first
      output: second
      starter: outer

  ponger:
    template: node
    channels:
      input: second
      output: first
      starter: outer

  launcher:
    template: firestarter
    channels:
      torch: outer
